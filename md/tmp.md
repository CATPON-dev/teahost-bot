# –°—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ 120 MB

–î–∞–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∂—ë—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ **120 MB**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ–∞–Ω—Å–æ–≤, —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ `/tmp` –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Ubuntu 22.04 –∏–ª–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å–∏—Å—Ç–µ–º–∞
- –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (sudo)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–≤–æ—Ç –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ

## 1. –°–æ–∑–¥–∞–Ω–∏–µ loop-—Ñ–∞–π–ª–∞ –ø–æ–¥ `/tmp` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 1.1. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤
```
sudo mkdir -p /var/lib/user-tmp
```

### 1.2. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞-–æ–±—Ä–∞–∑–∞ —Ä–∞–∑–º–µ—Ä–æ–º 120 MB
```
sudo fallocate -l 120M /var/lib/user-tmp/USERNAME-tmp.img
```
> ‚ö†Ô∏è **–ó–∞–º–µ–Ω–∏—Ç–µ `USERNAME` –Ω–∞ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**

### 1.3. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ ext4
```
sudo mkfs.ext4 /var/lib/user-tmp/USERNAME-tmp.img
```

## 2. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–≤–æ—Ç

### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
sudo mkdir -p /tmp/isolated/USERNAME
sudo chown USERNAME:USERNAME /tmp/isolated/USERNAME
```

### 2.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ /etc/fstab
–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ `/etc/fstab`:
```
/var/lib/user-tmp/USERNAME-tmp.img  /tmp/isolated/USERNAME  ext4  loop,usrquota,nodev,nosuid,noexec  0 0
```

### 2.3. –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
```
sudo mount /tmp/isolated/USERNAME
```

### 2.4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ –∫–≤–æ—Ç
```
sudo quotacheck -cum /tmp/isolated/USERNAME
sudo quotaon /tmp/isolated/USERNAME
```

### 2.5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∂—ë—Å—Ç–∫–æ–≥–æ –ª–∏–º–∏—Ç–∞ –≤ 120 MB
```
sudo setquota -u USERNAME 0 122880 0 0 /tmp/isolated/USERNAME
```
> üìù **122880 KB = 120 MB**

## 3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `/tmp`

### 3.1. –°–∏—Å—Ç–µ–º–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PAM
–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ `/etc/security/pam_env.conf`:
```
USERNAME DEFAULT=TMPDIR OVERRIDE=/tmp/isolated/USERNAME
USERNAME DEFAULT=TMP OVERRIDE=/tmp/isolated/USERNAME
USERNAME DEFAULT=TEMP OVERRIDE=/tmp/isolated/USERNAME
```

### 3.2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–î–æ–±–∞–≤—å—Ç–µ –≤ `~USERNAME/.bashrc`:
```
export TMPDIR=/tmp/isolated/USERNAME
export TMP=$TMPDIR
export TEMP=$TMPDIR
```

## 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 4.1. –¢–µ—Å—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
```
sudo -u USERNAME dd if=/dev/zero of=/tmp/isolated/USERNAME/test bs=1M count=200
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `No space left on device`

### 4.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
sudo quota -u USERNAME /tmp/isolated/USERNAME
```

### 4.3. –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞
```
df -h /tmp/isolated/USERNAME
```

## 5. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
#!/bin/bash
# setup-user-tmp.sh

USERNAME=$1
if [ -z "$USERNAME" ]; then
    echo "Usage: $0 "
    exit 1
fi

# –°–æ–∑–¥–∞—Ç—å loop-—Ñ–∞–π–ª –¥–ª—è tmp
sudo fallocate -l 120M /var/lib/user-tmp/${USERNAME}-tmp.img
sudo mkfs.ext4 /var/lib/user-tmp/${USERNAME}-tmp.img

# –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
sudo mkdir -p /tmp/isolated/$USERNAME
sudo chown $USERNAME:$USERNAME /tmp/isolated/$USERNAME

# –î–æ–±–∞–≤–∏—Ç—å –≤ fstab
echo "/var/lib/user-tmp/${USERNAME}-tmp.img /tmp/isolated/$USERNAME ext4 loop,usrquota,nodev,nosuid,noexec 0 0" | sudo tee -a /etc/fstab

# –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–≤–æ—Ç—ã
sudo mount /tmp/isolated/$USERNAME
sudo quotacheck -cum /tmp/isolated/$USERNAME
sudo quotaon /tmp/isolated/$USERNAME
sudo setquota -u $USERNAME 0 122880 0 0 /tmp/isolated/$USERNAME

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "$USERNAME DEFAULT=TMPDIR OVERRIDE=/tmp/isolated/$USERNAME" | sudo tee -a /etc/security/pam_env.conf
echo "$USERNAME DEFAULT=TMP OVERRIDE=/tmp/isolated/$USERNAME" | sudo tee -a /etc/security/pam_env.conf
echo "$USERNAME DEFAULT=TEMP OVERRIDE=/tmp/isolated/$USERNAME" | sudo tee -a /etc/security/pam_env.conf

echo "–ù–∞—Å—Ç—Ä–æ–µ–Ω –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π tmp –¥–ª—è $USERNAME: 120MB"
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
```
chmod +x setup-user-tmp.sh
sudo ./setup-user-tmp.sh username
```

## 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–≤–æ—Ç
```
sudo repquota -a | grep /tmp/isolated
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å –≤ crontab)
```
# –û—á–∏—â–∞—Ç—å —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * find /tmp/isolated/*/  -type f -mtime +1 -delete
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤:

- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **–µ–¥–∏–Ω—É—é** —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –Ω–∞ 120 MB –¥–ª—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚úÖ –í—Å–µ —Å–µ–∞–Ω—Å—ã –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ–¥–∏–Ω –æ–±—â–∏–π –ø—É–ª** –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
- ‚úÖ –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –¥–∞–ª—å–Ω–µ–π—à–∞—è –∑–∞–ø–∏—Å—å **–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è** –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–π `/tmp` –æ—Å—Ç–∞—ë—Ç—Å—è **–Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º** –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ª—É–∂–±
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç **DoS-–∞—Ç–∞–∫** —á–µ—Ä–µ–∑ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- üîí –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ–∞–Ω—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üõ°Ô∏è –ó–∞—â–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –æ—Ç –∞—Ç–∞–∫ —Ç–∏–ø–∞ "–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞ —á–µ—Ä–µ–∑ /tmp"
- üìä –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ª—É–∂–±
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º—É
